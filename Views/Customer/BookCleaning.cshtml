@{
    ViewData["Title"] = "Book a Cleaning";
    var customerName = ViewBag.CustomerName ?? "Customer";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .form-icon {
        width: 2rem;
        text-align: center;
        color: #2c786c;
    }

    .card {
        border-radius: 20px;
        padding: 2rem;
        border: none;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        background: white;
    }

    .service-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

        .service-card:hover {
            border-color: #2c786c;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(44, 120, 108, 0.2);
        }

        .service-card.selected {
            border-color: #2c786c;
            background: linear-gradient(135deg, #f8fffe 0%, #f0f9f8 100%);
        }

        .service-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f8f9fa;
        }

    .service-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: #2c786c;
    }

    .price-estimate {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: bold;
        margin-top: 0.5rem;
        display: inline-block;
    }

    .service-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff6b6b;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: bold;
    }

    .time-slot {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

        .time-slot:hover {
            border-color: #2c786c;
        }

        .time-slot.selected {
            background: #2c786c;
            color: white;
            border-color: #2c786c;
        }

        .time-slot.disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

    .bin-size-option, .carpet-size-option {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

        .bin-size-option:hover, .carpet-size-option:hover {
            border-color: #2c786c;
        }

        .bin-size-option.selected, .carpet-size-option.selected {
            background: #2c786c;
            color: white;
            border-color: #2c786c;
        }

    .booking-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .smart-alert {
        border-left: 4px solid #2c786c;
        background: #f8fffe;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .limit-badge {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .customer-welcome {
        background: linear-gradient(135deg, #2c786c, #004445);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
    }
</style>

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-12 col-lg-10">
            <div class="card">
                <!-- Customer Welcome -->
                <div class="customer-welcome">
                    <h4 class="mb-2">Welcome, @customerName!</h4>
                    <p class="mb-0">Ready to book your cleaning service? We've got you covered!</p>
                </div>

                <!-- Header -->
                <div class="text-center mb-4">
                    <h2 class="fw-bold" style="color: #2c786c;">
                        <i class="fa-solid fa-broom me-2"></i>Book Your Cleaning Service
                    </h2>
                    <p class="text-muted">Smart booking - Active bookings prevent new ones</p>
                </div>

                @if (ViewBag.Success != null)
                {
                    <div class="alert alert-success text-center">
                        <i class="fa-solid fa-check-circle me-2"></i>
                        ✅ Cleaning booked for <strong>@ViewBag.BookingDate</strong> at <strong>@ViewBag.Address</strong>.
                        <br />You'll receive a confirmation email shortly. The admin will set the final price.
                    </div>
                }

                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <div>@error.ErrorMessage</div>
                        }
                    </div>
                }

                <!-- Booking Stats -->
                <div class="booking-stats">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 id="availableSlots">0</h4>
                            <small>Available Slots Today</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="dailyBookings">0/1</h4>
                            <small>Active Bookings</small>
                        </div>
                        <div class="col-md-3">
                            <h4><i class="fa fa-user-check"></i></h4>
                            <small>@customerName</small>
                        </div>
                        <div class="col-md-3">
                            <h4>< 24h</h4>
                            <small>Quick Response</small>
                        </div>
                    </div>
                </div>

                <form method="post" id="bookingForm">
                    <!-- Smart Booking Alert -->
                    <div class="smart-alert" id="bookingLimitAlert" style="display: none;">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        <span id="alertMessage"></span>
                    </div>

                    <!-- Service Type Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">
                            <i class="fa fa-list-check me-2"></i>Select Service Type
                            <span class="limit-badge ms-2">Smart Limits</span>
                        </label>

                        <div class="row">
                            <!-- Dustbin Cleaning -->
                            <div class="col-md-4">
                                <div class="service-card text-center" data-service="dustbin" data-price="150">
                                    <div class="service-icon">
                                        <i class="fa fa-trash-can"></i>
                                    </div>
                                    <h5>Dustbin Cleaning</h5>
                                    <p class="text-muted">Thorough cleaning and disinfection</p>
                                    <div class="price-estimate">
                                        From R150
                                    </div>
                                    <div class="service-badge">Popular</div>
                                </div>
                            </div>

                            <!-- Carpet Cleaning -->
                            <div class="col-md-4">
                                <div class="service-card text-center" data-service="carpet" data-price="300">
                                    <div class="service-icon">
                                        <i class="fa fa-rug"></i>
                                    </div>
                                    <h5>Carpet Cleaning</h5>
                                    <p class="text-muted">Deep cleaning and stain removal</p>
                                    <div class="price-estimate">
                                        From R300
                                    </div>
                                </div>
                            </div>

                            <!-- Special Request -->
                            <div class="col-md-4">
                                <div class="service-card text-center" data-service="special" data-price="0">
                                    <div class="service-icon">
                                        <i class="fa fa-star"></i>
                                    </div>
                                    <h5>Special Request</h5>
                                    <p class="text-muted">Multiple items or custom service</p>
                                    <div class="price-estimate">
                                        Custom Quote
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="serviceType" name="serviceType" required />
                        <input type="hidden" id="estimatedPrice" name="estimatedPrice" />
                    </div>

                    <!-- Size Selection (Dustbin) -->
                    <div class="mb-4" id="dustbinSizeSection" style="display: none;">
                        <label class="form-label fw-bold mb-3">
                            <i class="fa fa-arrows-alt me-2"></i>Select Bin Size & Quantity
                        </label>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="bin-size-option" data-size="small" data-price="150" data-workers="1">
                                    <h6>Small Bin</h6>
                                    <small>50-80L (1-2 bins)</small>
                                    <div class="price-estimate mt-2">R150</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="bin-size-option" data-size="medium" data-price="200" data-workers="1">
                                    <h6>Medium Bin</h6>
                                    <small>80-120L (1-2 bins)</small>
                                    <div class="price-estimate mt-2">R200</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="bin-size-option" data-size="large" data-price="250" data-workers="2">
                                    <h6>Large Bin</h6>
                                    <small>120-240L (1 bin)</small>
                                    <div class="price-estimate mt-2">R250</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="bin-size-option" data-size="xlarge" data-price="350" data-workers="2">
                                    <h6>Extra Large</h6>
                                    <small>240L+ (1 bin)</small>
                                    <div class="price-estimate mt-2">R350</div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="binSize" name="binSize" />
                    </div>

                    <!-- Size Selection (Carpet) -->
                    <div class="mb-4" id="carpetSizeSection" style="display: none;">
                        <label class="form-label fw-bold mb-3">
                            <i class="fa fa-ruler-combined me-2"></i>Select Carpet Size
                        </label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="carpet-size-option" data-size="small" data-price="300" data-workers="1">
                                    <h6>Small Room</h6>
                                    <small>Up to 20m²</small>
                                    <div class="price-estimate mt-2">R300</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="carpet-size-option" data-size="medium" data-price="450" data-workers="2">
                                    <h6>Medium Room</h6>
                                    <small>20-40m²</small>
                                    <div class="price-estimate mt-2">R450</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="carpet-size-option" data-size="large" data-price="600" data-workers="2">
                                    <h6>Large Room</h6>
                                    <small>40m²+</small>
                                    <div class="price-estimate mt-2">R600</div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="carpetSize" name="carpetSize" />
                    </div>

                    <!-- Special Request Section -->
                    <div class="mb-4" id="specialRequestSection" style="display: none;">
                        <label for="specialRequest" class="form-label fw-bold">
                            <i class="fa fa-edit me-2"></i>Special Request Details
                        </label>
                        <textarea id="specialRequest" name="specialRequest" class="form-control" rows="4"
                                  placeholder="Describe your special cleaning needs, number of items, specific requirements..."></textarea>
                        <div class="form-text">Use this for multiple bins, large areas, or custom cleaning services</div>
                    </div>

                    <!-- Booking Date -->
                    <div class="mb-4">
                        <label for="bookingDate" class="form-label fw-bold">
                            <i class="fa fa-calendar form-icon me-2"></i>Select Date
                        </label>
                        <input type="date" id="bookingDate" name="bookingDate" class="form-control form-control-lg"
                               min="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                        <div class="form-text" id="dateHelp"></div>
                    </div>

                    <!-- Time Slot Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">
                            <i class="fa fa-clock form-icon me-2"></i>Available Time Slots
                        </label>
                        <div class="row" id="timeSlotsContainer">
                            <!-- Time slots will be dynamically generated -->
                        </div>
                        <input type="hidden" id="bookingTime" name="bookingTime" required />
                    </div>

                    <!-- Address -->
                    <div class="mb-4">
                        <label for="address" class="form-label fw-bold">
                            <i class="fa fa-location-dot me-2"></i> Service Address
                        </label>
                        <input type="text" id="address" name="address" class="form-control form-control-lg"
                               placeholder="Enter your complete street address" required />
                        <div class="form-text">We'll send our team to this address</div>
                    </div>

                    <!-- Price & Worker Summary -->
                    <div class="alert alert-info" id="priceDisplay" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fa fa-money-bill-wave me-2"></i>
                                <strong>Estimated Price: <span id="displayPrice">R0</span></strong>
                                <br><small class="text-muted">Final price confirmed by admin</small>
                            </div>
                            <div id="workerEstimate" class="text-end">
                                <small><i class="fa fa-users me-1"></i>Estimated: <span id="workerCount">1</span> worker<span id="workerPlural">s</span></small>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary btn-lg w-100 py-3" id="submitBtn" style="background: linear-gradient(135deg, #2c786c, #004445); border: none;">
                        <i class="fa fa-paper-plane me-2"></i>
                        <span id="submitText">Book Cleaning Service</span>
                        <div class="spinner-border spinner-border-sm text-light ms-2" id="submitSpinner" style="display: none;"></div>
                    </button>

                    <!-- Smart Limit Notice -->
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fa fa-brain me-1"></i>
                            Smart System: Active bookings prevent new ones. Cancel existing to book again.
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Initialize variables
        let currentService = '';
        let hasActiveBooking = false;

        // Initialize date picker with restrictions
        const datePicker = flatpickr("#bookingDate", {
            minDate: "today",
            disable: [
                function(date) {
                    // Disable weekends
                    return (date.getDay() === 0 || date.getDay() === 6);
                }
            ],
            onChange: function(selectedDates, dateStr, instance) {
                updateTimeSlots();
                checkActiveBookings();
            }
        });

        // Service selection
        document.querySelectorAll('.service-card').forEach(card => {
            card.addEventListener('click', function() {
                if (this.classList.contains('disabled')) return;

                document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');

                currentService = this.getAttribute('data-service');
                document.getElementById('serviceType').value = currentService;

                // Show/hide relevant sections
                document.getElementById('dustbinSizeSection').style.display =
                    currentService === 'dustbin' ? 'block' : 'none';
                document.getElementById('carpetSizeSection').style.display =
                    currentService === 'carpet' ? 'block' : 'none';
                document.getElementById('specialRequestSection').style.display =
                    currentService === 'special' ? 'block' : 'none';

                // Reset size selections
                document.querySelectorAll('.bin-size-option, .carpet-size-option').forEach(opt => {
                    opt.classList.remove('selected');
                });

                updatePriceDisplay();
                checkActiveBookings();
                updateTimeSlots();
            });
        });

        // Size selection
        document.querySelectorAll('.bin-size-option, .carpet-size-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.bin-size-option, .carpet-size-option').forEach(opt => {
                    if (opt.parentElement.style.display !== 'none') {
                        opt.classList.remove('selected');
                    }
                });
                this.classList.add('selected');

                const size = this.getAttribute('data-size');
                const price = this.getAttribute('data-price');
                const workers = this.getAttribute('data-workers');

                if (currentService === 'dustbin') {
                    document.getElementById('binSize').value = size;
                    document.getElementById('estimatedPrice').value = price;
                } else if (currentService === 'carpet') {
                    document.getElementById('carpetSize').value = size;
                    document.getElementById('estimatedPrice').value = price;
                }

                updatePriceDisplay();
                updateWorkerEstimate(workers);
            });
        });

        // Update available time slots based on current time
        function updateTimeSlots() {
            const now = new Date();
            const selectedDate = new Date(document.getElementById('bookingDate').value);
            const isToday = selectedDate.toDateString() === now.toDateString();

            const timeSlots = [
                { value: 'Morning', label: 'Morning (8am - 12pm)', start: 8, end: 12 },
                { value: 'Afternoon', label: 'Afternoon (12pm - 4pm)', start: 12, end: 16 },
                { value: 'Evening', label: 'Evening (4pm - 6pm)', start: 16, end: 18 }
            ];

            const container = document.getElementById('timeSlotsContainer');
            container.innerHTML = '';

            let availableSlots = 0;

            timeSlots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'col-md-4';

                // Check if time slot has passed for today
                const isPastSlot = isToday && now.getHours() >= slot.end;
                const isCurrentSlot = isToday && now.getHours() >= slot.start && now.getHours() < slot.end;

                slotElement.innerHTML = `
                    <div class="time-slot ${isPastSlot ? 'disabled' : ''} ${isCurrentSlot ? 'current' : ''}"
                         data-time="${slot.value}" ${isPastSlot ? 'onclick="return false;"' : 'onclick="selectTimeSlot(this)"'}>
                        <h6>${slot.label}</h6>
                        ${isPastSlot ? '<small class="text-danger"><i class="fa fa-clock"></i> Time passed</small>' : ''}
                        ${isCurrentSlot ? '<small class="text-success"><i class="fa fa-bolt"></i> Available now</small>' : ''}
                    </div>
                `;

                if (!isPastSlot) availableSlots++;
                container.appendChild(slotElement);
            });

            document.getElementById('availableSlots').textContent = availableSlots;

            // If no slots available for today, suggest tomorrow
            if (isToday && availableSlots === 0) {
                document.getElementById('dateHelp').innerHTML =
                    '<span class="text-warning"><i class="fa fa-exclamation-triangle"></i> No more slots available today. Please select tomorrow.</span>';
            }
        }

        // Select time slot
        function selectTimeSlot(element) {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            element.classList.add('selected');
            document.getElementById('bookingTime').value = element.getAttribute('data-time');
        }

        // Update price display
        function updatePriceDisplay() {
            const priceDisplay = document.getElementById('priceDisplay');
            const displayPrice = document.getElementById('displayPrice');
            const estimatedPrice = document.getElementById('estimatedPrice').value;

            if (currentService && estimatedPrice > 0) {
                displayPrice.textContent = 'R' + estimatedPrice;
                priceDisplay.style.display = 'block';
            } else if (currentService === 'special') {
                displayPrice.textContent = 'Custom Quote';
                priceDisplay.style.display = 'block';
            } else {
                priceDisplay.style.display = 'none';
            }
        }

        // Update worker estimate
        function updateWorkerEstimate(workers) {
            const workerCount = document.getElementById('workerCount');
            const workerPlural = document.getElementById('workerPlural');

            workerCount.textContent = workers;
            workerPlural.textContent = workers > 1 ? 's' : '';
        }

        // Check for active bookings
        async function checkActiveBookings() {
            const selectedDate = new Date(document.getElementById('bookingDate').value);
            const dateStr = selectedDate.toISOString().split('T')[0];

            try {
                // This would be an API call to check for active bookings
                const response = await fetch(`/Customer/CheckActiveBooking?date=${dateStr}`);
                const result = await response.json();

                hasActiveBooking = result.hasActiveBooking;

                const alertDiv = document.getElementById('bookingLimitAlert');
                const alertMessage = document.getElementById('alertMessage');

                if (hasActiveBooking) {
                    alertMessage.innerHTML = `
                        <strong>Active Booking Found</strong><br>
                        You already have an active booking for this date. Please cancel your existing booking or choose a different date.
                    `;
                    alertDiv.style.display = 'block';

                    // Disable all services for this date
                    document.querySelectorAll('.service-card').forEach(card => {
                        card.classList.add('disabled');
                    });

                    document.getElementById('dailyBookings').textContent = '1/1';
                } else {
                    alertDiv.style.display = 'none';
                    document.querySelectorAll('.service-card').forEach(card => {
                        card.classList.remove('disabled');
                    });
                    document.getElementById('dailyBookings').textContent = '0/1';
                }
            } catch (error) {
                console.error('Error checking active bookings:', error);
            }
        }

        // Form submission
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');

            // Validate service selection
            if (!currentService) {
                e.preventDefault();
                showAlert('Please select a service type', 'warning');
                return false;
            }

            // Validate size selection for dustbin/carpet
            if ((currentService === 'dustbin' && !document.getElementById('binSize').value) ||
                (currentService === 'carpet' && !document.getElementById('carpetSize').value)) {
                e.preventDefault();
                showAlert('Please select a size for your ' + currentService, 'warning');
                return false;
            }

            // Validate time slot
            if (!document.getElementById('bookingTime').value) {
                e.preventDefault();
                showAlert('Please select a time slot', 'warning');
                return false;
            }

            // Check if already has active booking
            if (hasActiveBooking) {
                e.preventDefault();
                showAlert('You already have an active booking for this date. Please cancel it first or choose a different date.', 'warning');
                return false;
            }

            // Show loading state
            submitText.textContent = 'Processing Booking...';
            submitSpinner.style.display = 'inline-block';
            submitBtn.disabled = true;
        });

        // Utility function to show alerts
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card').insertBefore(alertDiv, document.querySelector('form'));

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateTimeSlots();
            checkActiveBookings();

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').min = today;
            document.getElementById('bookingDate').value = today;

            // Focus on service selection
            document.querySelector('.service-card[data-service="dustbin"]').focus();
        });
    </script>
}